# maybe-proxy
Сервис для развертывания прокси серверов 

## Общая структура
Прокси сервис состоит из двух частей:
1. `master` - управляющая часть, отвечает за внешний API, ротацию и управление нодами.
2. `node` (или узел) - агент, запускающий процессы с прокси на конечных серверах. Может работать автономно при потере соединения с мастером, но получает сообщения только от него.

В качестве бекенда для запуска прокси на данный момент используется 3proxy.

Можно иметь неограниченное количество нод, дополнительно их можно группировать в локации.

Когда нужно создать прокси сервер, нужно вызвать API метод у мастера, передав туда желаемую локацию и/или набор нод.

## Установка
Мастер поставляется как докер образ, для развертывания можете запускать его любым удобным способом.

### Мастер
Сначала нужно установить следующие зависимости:
- postgres

Дальше нужно скачать докер образ мастера:
```docker pull cr.yandex/crp428vimkuuip6nnfgs/maybe-proxy-master```

При запуске нужно передать следующие переменные окружения:
```
DATABASE_HOST=
DATABASE_PORT=
DATABASE_USERNAME=
DATABASE_PASSWORD=
DATABASE_NAME=
LICENSE_KEY=
```

Лицензионный ключ нужно получить у дистрибьютора, через которого Вы покупали ПО.

### Нода
TODO

## Подключение ноды
После установки нужного софта на сервер для ноды, запускается нода в режиме ожидания подключения.

В режиме ожидания создается случайный код `challenge` и прослушиваются http запросы. Со стороны мастера нужно вызвать API метод на подключение, передав туда IP ноды и код. Если все данные будут введены верно, на ноде будет создан стандартный конфиг, ему будет выбрано случайное имя и ID. Дальнейшая работа с нодой будет происходить с использованием этого ID.

Пример вызова `POST /nodes`:
```json
{
  "ip": "127.0.0.1",
  "challenge": "12345qwerty"
}
```

## Cинхронизация
> Так как ноды имеют локальную копию проксей (для автономной работы если мастер будет недоступен), то им требуется синхронизация.

1. Мастер берет из базы список прокси, относящийся к определенной ноде, вытаскивает оттуда только ID и версию, которые массивом отправляет ноде команду `check-sync`.
2. Нода сравнивает полученные айдишники и версии с локальными данными. Если у ноды есть прокси, которого нет в списке, то нода удаляет его и останавливает процесс прокси. Если у ноды нет прокси из списка или различается версия, то нода отправляет их пачкой на сервер с командой `need-sync`. Мастер получает актуальную информацию этих прокси и отправляет на ноду с командой `sync`.

## API
API расположен на порту 3005.
Стоит принять во внимание, что api не имеет никакой авторизации или шифрования и предполагается, что API будет скрыто от посторонних пользователей на уровне сети.

По адресу `http://localhost:3005/api` доступен интерфейс документации API, а по адресу `http://localhost:3005/api-json` доступна схема API в формате openapi.

## Roadmap
- [ ] Создание нескольких прокси серверов за раз и объединение их в стаки.
- [ ] Роут SSE для получения событий в реальном времени.
- [ ] Веб интерфейс для администратирования.
- [ ] Прокси серверы с рандомным ipv6
- [ ] Отказ от 3proxy в пользу собственного решения
- [ ] Упрощенная дистрибьюция ноды.